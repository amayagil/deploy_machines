---
- name: Create ansible user in AWS machines
  hosts: all
  gather_facts: true

  tasks:
  - name: Create key file
    ansible.builtin.copy:
      content: "{{ key_pair }}"
      dest: /tmp/key
      mode: 0600

  - name: Create ansible user
    ansible.builtin.user:
      name: ansible
      shell: /bin/bash
      groups: wheel, adm
      state: present
      password: "{{ 'redhat' | password_hash('sha512') }}"
      ssh_key_file: "{{ lookup(ansible.builtin.file,'/tmp/key') }}"
      append: yes