---
- name: Prepare machines for use with Red Hat
  hosts: localhost
  gather_facts: true

  vars:
    insights_auth_user: "{{ rhsm_username }}"
    insights_auth_password: "{{ rhsm_password  }}"
    insights_api_url: "https://console.redhat.com/api"
    recommendation_id: "{{ recommendation_id}}"
    #playbook: playbook.yml

  tasks:
    - name: Pull info from Insights API
      ansible.builtin.uri:
        url: "{{ insights_api_url }}/vulnerability/v1/vulnerabilities/cves?affecting=true"
        method: GET
        user: "{{ insights_auth_user }}"
        password: "{{ insights_auth_password }}"
        force_basic_auth: true
        return_content: yes
      register: insights_api
      #failed_when: insights_api is failed or "'CVE' not in insights_api.content"

    - name: ver insights_api
      ansible.builtin.debug:
        msg: "todo {{ insights_api.content }}"

    - name: Set result json as fact
      ansible.builtin.set_fact:
        insights_api_data_json: "{{ (insights_api.content | from_json).data }}"
        #insights_api_json: "{{ insights_api.content | from_json }}"

    - name: List ALL data of ALL CVEs
      ansible.builtin.debug:
        msg: 
        - "CVE Description: {{ item.attributes.description }}"
        - "CVE Synopsis: {{ item.attributes.synopsis }}"
        - "CVE Impact: {{ item.attributes.impact }}"
        verbosity: 0
      loop: "{{ insights_api_data_json }}"
      #loop: "{{ insights_api_json['data'] }}"

#
#    - name: Display system details
#      ansible.builtin.debug:
#        var: "{{ insights_api_data_json }}"
        #var: "{{ insights_api_json | community.general.json_query('[data]') }}"
